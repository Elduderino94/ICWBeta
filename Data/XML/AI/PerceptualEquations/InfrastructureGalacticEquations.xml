<?xml version="1.0" ?>

<Equations>

	<!--
	Do we have some structure here already
	AND
	Are we not maxed out
	SCALE UP BY
		Chokepoint status
		Income
		Distance from max potential base level
		Need to reduce maintaince tax
	-->
	<Needs_Groundbase_Upgrade>
		(Variable_Target.GroundbaseLevel > 0.0)
		*
		(Variable_Target.MaxGroundbaseLevel != Variable_Target.GroundbaseLevel)
		*
		(
			4.0 * (Variable_Target.Hints.Chokepoint)
			+
			2.0 * Variable_Target.BaseIncomeNBTP
			+
			1.0 * (Variable_Target.MaxGroundbaseLevel - Variable_Target.GroundbaseLevel)
			+
			4.0 * Function_Is_Connected_To_Enemy.Evaluate
		)
		/
		7.0
	</Needs_Groundbase_Upgrade>

	<!--
	Bring this into line with ground base component building (since they share the infrastructure category)
	AND
	Do we already have an initial base (handled by another goal)
	AND
	Zero out desire when defending the home planet (template change isn't enough)
	AND
	Are we not already maxed out
	AND
	Scale by relative economic worth
	AND EITHER
		lift a tech upgrade purchase dependency OR offensive space production dependency
		if this is a location with a ground research facility
		OR
		If we're badly blocked on space production
		OR
		If we don't need a tech upgrade dependency lifted, scale desire by:
			if this is a chokepoint planet
			by likely purchase needs (high tech can only be bought at high level bases)
			by how far we are from maxing out base upgrades


	UNUSED:
         Require the starbase upgrade boost for unblocking tech to be on the highest level system.
			*
			(Variable_Target.StarbaseLevelUnnormalized == Variable_Self.MaxStarbaseLevelUnnormalized)

      -->
	<Needs_Starbase_Upgrade>
		(Variable_Target.StarbaseLevel > 0.0)
		*
		(Variable_Target.MaxStarbaseLevel != Variable_Target.StarbaseLevel)
		*
		((Variable_Target.MaxGroundbaseLevel > Variable_Target.StarbaseLevel) + (Variable_Target.MaxStarbaseLevel >= Variable_Target.MaxGroundbaseLevel))
		*
		(
			(
				4.0 * (Variable_Target.Hints.Chokepoint + Function_Is_Connected_To_Enemy.Evaluate)
				+
				2.0 * Function_Needs_Better_Buying_Capability_Space.Evaluate
			)
		)
	</Needs_Starbase_Upgrade>

	<!-- Determine if this target planet needs to better assist production.

	If we prefer having a higher ratio of level X starbases to this many planets controlled,
	AND
	This planet is level X-1
	OR
	...
	-->
	<Needs_Better_Buying_Capability_Space>
		12 * ((0.33 - (Variable_Self.NumStarbaseOfLevel {Parameter_Level = 2} / Variable_Self.PlanetsControlledUnnormalized)) > 0) *
		(Variable_Target.StarbaseLevelUnnormalized == 1.0)
		+
		10 * ((0.25 - (Variable_Self.NumStarbaseOfLevel {Parameter_Level = 3} / Variable_Self.PlanetsControlledUnnormalized)) > 0) *
		(Variable_Target.StarbaseLevelUnnormalized == 2.0)
	</Needs_Better_Buying_Capability_Space>

	<!-- SCALE DOWN as we improve to the desired ratio of structures per planet
	PLUS
	Boost if we need to upgrade the base
	-->
	<Need_Light_Vehicle_Factory>
		20 * clamp(0.5 - (Variable_Self.StructureCount {Parameter_Type = "E_Ground_Light_Vehicle_Factory",
													Parameter_Type = "R_Ground_Light_Vehicle_Factory",
													Parameter_Type = "C_Ground_Light_Vehicle_Factory",
													Parameter_Type = "P_Ground_Light_Vehicle_Factory",
													Parameter_Only_Consider_Complete = 1.0} /
													Variable_Self.PlanetsControlledUnnormalized), 0.1, 0.5)
		*
		(
			Function_Needs_Groundbase_Upgrade.Evaluate
			+
			(3.0 * Variable_Target.StructureCount {Parameter_Type = "E_Ground_Light_Vehicle_Factory",
													Parameter_Type = "R_Ground_Light_Vehicle_Factory",
													Parameter_Type = "C_Ground_Light_Vehicle_Factory",
													Parameter_Type = "P_Ground_Light_Vehicle_Factory",
													Parameter_Only_Consider_Complete = 1.0})
		)
		*
		(3 > Variable_Target.StructureCount {Parameter_Type = "E_Ground_Light_Vehicle_Factory",
													Parameter_Type = "R_Ground_Light_Vehicle_Factory",
													Parameter_Type = "C_Ground_Light_Vehicle_Factory",
													Parameter_Type = "P_Ground_Light_Vehicle_Factory",
													Parameter_Only_Consider_Complete = 1.0})
		*
		(Function_Should_Save_For_Desirable_Structures.Evaluate == 0)
	</Need_Light_Vehicle_Factory>

	<!-- Same kind of deal as vehicle factory -->
	<Need_Barracks>
		20 * clamp(0.5 - (Variable_Self.StructureCount {Parameter_Type = "E_Ground_Barracks",
														Parameter_Type = "R_Ground_Barracks",
														Parameter_Type = "P_Ground_Barracks",
														Parameter_Only_Consider_Complete = 1.0} /
														Variable_Self.PlanetsControlledUnnormalized), 0.1, 0.5)
		*
		(
			Function_Needs_Groundbase_Upgrade.Evaluate
			+
			(3.0 * Variable_Target.StructureCount {Parameter_Type = "E_Ground_Barracks",
													Parameter_Type = "R_Ground_Barracks",
													Parameter_Type = "P_Ground_Barracks",
													Parameter_Only_Consider_Complete = 1.0})
		)
		*
		(2 > Variable_Target.StructureCount {Parameter_Type = "E_Ground_Barracks",
													Parameter_Type = "R_Ground_Barracks",
													Parameter_Type = "P_Ground_Barracks",
													Parameter_Only_Consider_Complete = 1.0})
		*
		(Function_Should_Save_For_Desirable_Structures.Evaluate == 0)
	</Need_Barracks>

	<!-- SCALE DOWN as we improve to the desired ratio of structures per planet
	PLUS
	Boost if we need to upgrade the base
	PLUS
	Bonus for stacking
	-->
	<Need_Heavy_Vehicle_Factory>
		(
			25 * clamp(0.4 - (Variable_Self.StructureCount {Parameter_Type = "E_Ground_Heavy_Vehicle_Factory",
														Parameter_Type = "R_Ground_Heavy_Vehicle_Factory",
														Parameter_Type = "P_Ground_Heavy_Vehicle_Factory",
														Parameter_Only_Consider_Complete = 1.0} /
														Variable_Self.PlanetsControlledUnnormalized), 0.1, 0.4)
			+
			3 * Function_Needs_Groundbase_Upgrade.Evaluate
			+
			(5.0 * Variable_Target.StructureCount {Parameter_Type = "E_Ground_Heavy_Vehicle_Factory",
													Parameter_Type = "R_Ground_Heavy_Vehicle_Factory",
													Parameter_Type = "P_Ground_Heavy_Vehicle_Factory",
													Parameter_Only_Consider_Complete = 1.0})
		)
		*
		(3 > Variable_Target.StructureCount {Parameter_Type = "E_Ground_Heavy_Vehicle_Factory",
													Parameter_Type = "R_Ground_Heavy_Vehicle_Factory",
													Parameter_Type = "P_Ground_Heavy_Vehicle_Factory",
													Parameter_Only_Consider_Complete = 1.0})
	</Need_Heavy_Vehicle_Factory>

	<!-- Provided we're the Empire faction
	SCALE DOWN as we improve to the desired ratio of structures per planet
	PLUS
	Boost if we need to upgrade the base
	PLUS
	Bonus for stacking
	-->
	<Need_Advanced_Vehicle_Factory>
		Variable_Self.IsFaction {Parameter_Faction = "Empire", 
								Parameter_Faction = "Yevetha", 
								Parameter_Faction = "Hutts", 
								Parameter_Faction = "Pentastar", 
								Parameter_Faction = "Pirates", 
								Parameter_Faction = "Teradoc"}
		*
		(
			25 * clamp(0.4 - (Variable_Self.StructureCount {Parameter_Type = "E_Ground_Advanced_Vehicle_Factory",
															Parameter_Type = "P_Ground_Advanced_Vehicle_Factory",
														Parameter_Only_Consider_Complete = 1.0} /
														Variable_Self.PlanetsControlledUnnormalized), 0.1, 0.4)
			+
			5 * Function_Needs_Groundbase_Upgrade.Evaluate
			+
			(5.0 * Variable_Target.StructureCount {Parameter_Type = "E_Ground_Advanced_Vehicle_Factory",
													Parameter_Type = "P_Ground_Advanced_Vehicle_Factory",
													Parameter_Only_Consider_Complete = 1.0})
		)
		*
		(3 > Variable_Target.StructureCount {Parameter_Type = "E_Ground_Advanced_Vehicle_Factory",
											Parameter_Type = "P_Ground_Advanced_Vehicle_Factory",
											Parameter_Only_Consider_Complete = 1.0})
	</Need_Advanced_Vehicle_Factory>

	<!-- Does this planet have a starbase already? -->
	<Needs_Initial_Starbase>
		50.0 *
		(1.0 - clamp(Variable_Self.PlanetsControlled - 0.33, 0.0, 1.0)) *
		(Variable_Target.StarbaseLevel == 0.0) *
		(Variable_Target.MaxStarbaseLevel > 0.0) *
        (Variable_Target.EnemyForce.HasSpaceForce == 0)
	</Needs_Initial_Starbase>

	<!-- Does this planet have a groundbase already?  This now builds a barracks.
	High base desire
	AND
	Only needed if we don't yet have a groundbase
	AND
	Only needed if we can build a groundbase
	AND
	Wait until the starbase has been built, if one can be
	-->
	<Needs_Initial_Groundbase>
		50.0
		*
		(1.0 - clamp(Variable_Self.PlanetsControlled - 0.33, 0.0, 1.0))
		*
		(Variable_Target.GroundbaseLevel == 0.0)
		*
		(Variable_Target.MaxGroundbaseLevel > 0)
		*
		((Variable_Target.StarbaseLevel > 0) + (Variable_Target.MaxStarbaseLevel == 0.0))
	</Needs_Initial_Groundbase>

	<!-- Desire to build a mine.
		desirability is like arenas
		PLUS
		bonus for stacking mining facilities (effects are cumulative)
		AND
		Maximum four per planet
		AND
		Must have basic build facilities first
		-->
	<Needs_Mining_Facility>
		(
			(
				10.0
				*
				(1.0 + Variable_Target.IncomeUnnormalized * Variable_Target.IncomeUnnormalized / 25000.0)
				+
				10 * (0.5 > (Variable_Self.StructureCount {Parameter_Type = "Empire_Ground_Mining_Facility", 
															Parameter_Type = "Pentastar_Commercial_Entity", 
															Parameter_Type = "Rebel_Ground_Mining_Facility",
															Parameter_Type = "U_Ground_Mining_Facility",
															Parameter_Type = "Generic_Tradestation",
															Parameter_Only_Consider_Complete = 1.0} / Variable_Self.PlanetsControlledUnnormalized))
			)
			*
			clamp(Function_Defense_Level.Evaluate - 1, 0.1, 2.0)
			*
			((Variable_Target.MaxStructureSlotsUnnormalized / 2.0) > Variable_Target.StructureCount {Parameter_Type = "Empire_Ground_Mining_Facility",
																									Parameter_Type = "Rebel_Ground_Mining_Facility",
																									Parameter_Type = "Pentastar_Commercial_Entity",
																									Parameter_Type = "U_Ground_Mining_Facility",
																									Parameter_Type = "Generic_Tradestation",
																									Parameter_Only_Consider_Complete = 1.0})
			*
			Variable_Self.HasStructure {Parameter_Type = "E_Ground_Barracks",
										Parameter_Type = "R_Ground_Barracks",
										Parameter_Type = "P_Ground_Barracks",
										Parameter_Type = "C_Ground_Barracks",
										Parameter_Only_Consider_Complete = 1.0}
			*
			(Function_Should_Save_For_Desirable_Structures.Evaluate == 0)
			+
			50.0
			*
			(Variable_Self.HasStructure {Parameter_Type = "Empire_Ground_Mining_Facility",
										Parameter_Type = "Rebel_Ground_Mining_Facility",
										Parameter_Type = "Pentastar_Commercial_Entity",
										Parameter_Type = "U_Ground_Mining_Facility",
										Parameter_Type = "Generic_Tradestation",
										Parameter_Only_Consider_Complete = 1.0} == 0.0)
		)
		*
		(0.1 + 0.9 * (Function_Is_Connected_To_Enemy.Evaluate == 0))
	</Needs_Mining_Facility>

	<!--
		are we Rebels?
		AND
		Is the system reasonably defended
		AND
		make sure it's not a chokepoint system (would waste a slot there)
		AND
		scale by how many open slots we have
		AND
		We can't really use more than 2 total of this structure
		AND
		Have we already addressed production bottleneck issues
		AND
		Big Bonus if we have no structure of this type yet
		-->
	<Needs_Ground_Infiltrator_Facility>
		(
			5.0
			*
			(Variable_Self.IsFaction {Parameter_Faction = "Rebel"})
			*
			Function_Defense_Level.Evaluate
			+
			5.0 * Variable_Target.HasStructure {Parameter_Type = "Ground_Infiltrator_Facility"}
		)
		*
		(2.0 > Variable_Target.StructureCount {Parameter_Type = "Ground_Infiltrator_Facility", Parameter_Only_Consider_Complete = 1.0})
		*
		(Function_Should_Save_For_Desirable_Structures.Evaluate == 0)
	</Needs_Ground_Infiltrator_Facility>

	<Should_Save_For_Desirable_Structures>
		(Variable_Target.GroundBaseLevelUnnormalized > 1.0)
		*
		(
			(Function_Need_Heavy_Vehicle_Factory.Evaluate > 10.0)
			+
			(Function_Need_Advanced_Vehicle_Factory.Evaluate > 10.0)
			+
			(Function_Needs_Weapon.Evaluate > 15.0)
			+
			(Function_Needs_Base_Shield.Evaluate > 15.0)
			+
			(Function_Needs_Turbolasers.Evaluate > 15.0)
		)
	</Should_Save_For_Desirable_Structures>

	<Num_Planets_Controlled>
		Variable_Self.PlanetsControlledUnnormalized
	</Num_Planets_Controlled>

	<Num_Enemy_Space_Territories>
		Variable_Human.SpaceDefendedPlanets * Variable_Human.PlanetsControlledUnnormalized
	</Num_Enemy_Space_Territories>

	<Num_Enemy_Land_Territories>
		Variable_Human.GroundDefendedPlanets * Variable_Human.PlanetsControlledUnnormalized
	</Num_Enemy_Land_Territories>

	<Enemy_Planets_Controlled>
		Variable_Human.PlanetsControlledUnnormalized
	</Enemy_Planets_Controlled>

	<Has_Starbase>
		Variable_Target.StarbaseLevel > 0
	</Has_Starbase>

	<Need_Ground_Company>
		(Variable_Target.StarbaseLevelUnnormalized > 1)
		*
		clamp(Function_Defense_Level.Evaluate, 0.0, 2.0)
		*
		Function_Needs_Groundbase_Upgrade.Evaluate	
	</Need_Ground_Company>
	
	<Need_Space_Company>
		(Variable_Target.StarbaseLevelUnnormalized > 1)
	</Need_Space_Company>
	
	<Need_Capital_Building>
		10
		*
		(Variable_Target.StarbaseLevelUnnormalized > 0)
		*
		clamp(Function_Defense_Level.Evaluate, 0.0, 2.0)
		*
		(1 - Function_Has_Capital_Building.Evaluate)
		*
		(1 + Function_Is_Home_Planet.Evaluate)
		*
		Function_Needs_Groundbase_Upgrade.Evaluate
	</Need_Capital_Building>
	
	<Has_Capital_Building>
				(Variable_Self.HasStructure{Parameter_Type = "Remnant_Capital"} * Variable_Self.IsFaction{Parameter_Faction = "Empire"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "PA_Capital"} * Variable_Self.IsFaction{Parameter_Faction = "Pentastar"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "Maldrood_Capital"} * Variable_Self.IsFaction{Parameter_Faction = "Teradoc"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "Eriadu_Capital"} * Variable_Self.IsFaction{Parameter_Faction = "Hutts"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "NewRep_Senate"} * Variable_Self.IsFaction{Parameter_Faction = "Rebel"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "Rancor_Base"} * Variable_Self.IsFaction{Parameter_Faction = "Pirates"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "Yevetha_Capital"} * Variable_Self.IsFaction{Parameter_Faction = "Yevetha"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "CSA_Capital"} * Variable_Self.IsFaction{Parameter_Faction = "Corporate_Sector"})
				+
				(Variable_Self.HasStructure{Parameter_Type = "U_Ground_Palace"} * Variable_Self.IsFaction{Parameter_Faction = "Underworld"})
	</Has_Capital_Building>
	
	<Planet_Has_Capital_Building>
				Variable_Target.HasStructure{Parameter_Type = "Remnant_Capital"}
				+
				Variable_Target.HasStructure{Parameter_Type = "PA_Capital"}
				+
				Variable_Target.HasStructure{Parameter_Type = "Maldrood_Capital"}
				+
				Variable_Target.HasStructure{Parameter_Type = "Eriadu_Capital"}
				+
				Variable_Target.HasStructure{Parameter_Type = "NewRep_Senate"}
				+ 
				Variable_Target.HasStructure{Parameter_Type = "Rancor_Base"}
				+
				Variable_Target.HasStructure{Parameter_Type = "Yevetha_Capital"} 
				+
				Variable_Target.HasStructure{Parameter_Type = "CSA_Capital"}
				+
				Variable_Target.HasStructure{Parameter_Type = "U_Ground_Palace"}
	</Planet_Has_Capital_Building>
	
</Equations>
